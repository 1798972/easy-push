# 📦 Easy-Push 扩展用法

------

## 1. NodeInsertRegistry —— **节点插入机制**

### 功能说明

- 允许用户在平台已定义的消息责任链（MessageChain）中**指定下标位置，插入自定义节点**（MessageNodeAdapter），
- 插入顺序完全可控，平台链节点列表初始化后自动合并用户插入节点。
- 支持链路多节点插入，支持多个用户插件共存。

### 使用示例

**平台链路默认节点（如）：**
 `[CheckNode, ContentNode, SendNode]`

**业务侧插入自定义节点到第1位：**

```java
NodeInsertRegistry.register(
    MessageChainDing.class, // 目标链类型
    MyCustomNode.class,     // 你的自定义Node类型
    1                       // 插入下标（0为头）,即放到1号位置
);
```

**最终链路：**
 `[CheckNode, MyCustomNode, ContentNode, SendNode]`

- 支持插入多个节点，每次调用 register。
- 插入顺序、位置清晰直观。

------



## 2. ChainEnhanceRegistry —— **全局链路增强拦截器**

### 功能说明

- 允许用户**对所有链/所有节点执行前后增强逻辑**（如埋点、日志、监控、全局异常、鉴权等）。
- 类似 Filter/AOP，一次注册、全局生效。
- 用户可在实现时按需判断链或节点类型，或直接全局处理。

### 使用示例

**注册一个全局日志拦截器：**

```java
ChainEnhanceRegistry.register(new ChainInterceptor() {
    @Override
    public void beforeNode(MessageChain chain, MessageNodeAdapter node, MessageContext ctx) {
        System.out.println("[全局增强] 执行前: " + chain.getClass().getSimpleName() + " -> " + node.getClass().getSimpleName());
    }
    @Override
    public void afterNode(MessageChain chain, MessageNodeAdapter node, MessageContext ctx) {
        System.out.println("[全局增强] 执行后: " + chain.getClass().getSimpleName() + " -> " + node.getClass().getSimpleName());
    }
});
```

- 支持注册多个 ChainInterceptor，依次调用。
- 典型用法：日志、traceId注入、耗时统计、全局异常等。

------



## 3. NodeEnhanceRegistry —— **定向节点增强拦截器**

### 功能说明

- 允许用户**精确指定某条链某个节点的前后增强逻辑**，零 if 判断，按链+节点唯一定位。
- 支持注册多个定向增强，互不干扰。
- 适合业务侧做“节点级埋点”、“节点前后自定义hook”、“节点局部灰度/开关”等。

### 使用示例

**只增强 Ding 链的 ContentNode：**

```java
NodeEnhanceRegistry.register(
    MessageChainDing.class,            // 目标链类型
    DingTextContentNode.class,         // 目标节点类型
    new NodeInterceptor() {
        @Override
        public void beforeNode(Class<? extends MessageChain> chainClass,
                               Class<? extends MessageNodeAdapter> nodeClass,
                               MessageNodeAdapter node, MessageContext ctx) {
            System.out.println("【增强】只在DingTextContentNode前执行，无需if判断！");
        }
    }
);
```

- 只会在“Ding链+ContentNode节点”命中时触发，**无需业务再写判断条件**。
- 支持批量注册多个定向增强（如不同节点不同功能）。

------

## 4. 总结对比表

| 机制                 | 控制粒度        | 典型应用场景       | 业务代码复杂度 |
| -------------------- | --------------- | ------------------ | -------------- |
| NodeInsertRegistry   | 链+位置（下标） | 动态插入自定义节点 | 最简，仅1行    |
| ChainEnhanceRegistry | 全局节点        | 横切增强/日志等    | 简单           |
| NodeEnhanceRegistry  | 链+节点类型     | 定向hook/节点埋点  | 极简，无if     |



------

## 5. 建议使用规范

- **节点插入**：只用关心插入下标和 Node 类型（看文档说明链路节点顺序）
- **全局增强**：适合所有链/所有节点共性功能
- **定向节点增强**：精准定位链+节点，适合埋点、局部扩展

